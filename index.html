<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>KCMH DBT Research</title>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#eef7f3;
  color:#2f4f4f;
}

header{
  text-align:center;
  padding:30px 20px;
  background:#dff3ea;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
}

input{
  margin-top:12px;
  padding:10px;
  border-radius:8px;
  border:1px solid #b7e4d4;
  width:240px;
  font-size:16px;
}

.container{
  max-width:900px;
  margin:auto;
  padding:30px;
}

.module{
  border-radius:16px;
  padding:25px;
  margin-bottom:25px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
}

.locked{ opacity:.5; pointer-events:none; }

.mindfulness{ background:#e8f4ef; }
.emotion{ background:#e6f3f3; }

.video-block{ margin-top:18px; }

.locked-video{
  opacity:.4;
  pointer-events:none;
}

.badge{
  background:#7ec8a9;
  color:white;
  padding:3px 10px;
  border-radius:12px;
  font-size:12px;
  margin-left:8px;
}

.continue{
  color:#2f4f4f;
  font-size:12px;
  margin-left:8px;
}

.progress-bar{
  height:10px;
  background:#e0f2ea;
  border-radius:10px;
  margin-top:15px;
  overflow:hidden;
}

.progress-fill{
  height:100%;
  width:0%;
  background:#7ec8a9;
  transition:.4s ease;
}

.percent{ font-size:14px; margin-top:6px; }
.icon{ font-size:22px; margin-right:8px; }
</style>
</head>
<body>

<header>
  <h1>KCMH DBT Research</h1>
  <input id="code" placeholder="Enter participant code">
</header>

<div class="container">

<!-- MINDFULNESS -->
<div class="module mindfulness" id="module1">
<h2><span class="icon">ðŸ§˜</span>Mindfulness</h2>

<div class="video-block" id="block1">
<p>
<strong>Video 1:</strong> Intro to What Skills
<span id="c1" class="badge" style="display:none;">âœ“</span>
<span id="continue1" class="continue" style="display:none;">Continue watching</span>
</p>
<div id="player1"></div>
</div>

<div class="video-block locked-video" id="block2">
<p>
<strong>Video 2:</strong> What Skill: Observe
<span id="c2" class="badge" style="display:none;">âœ“</span>
<span id="continue2" class="continue" style="display:none;">Continue watching</span>
</p>
<div id="player2"></div>
</div>

<div class="progress-bar"><div id="bar1" class="progress-fill"></div></div>
<div id="p1" class="percent">0%</div>
</div>

<!-- EMOTION REGULATION -->
<div class="module emotion locked" id="module2">
<h2><span class="icon">ðŸŒ¿</span>Emotion Regulation</h2>
<p>Unlocked after completing Mindfulness</p>
</div>

</div>

<script>
const vids={
  player1:"gfvzWq8eW6s",
  player2:"PZBlkmMbzwI"
};

let players={};
let lastVideo=null;

function onYouTubeIframeAPIReady(){
  for(let id in vids){
    players[id]=new YT.Player(id,{
      height:"360",
      width:"100%",
      videoId:vids[id],
      playerVars:{rel:0,modestbranding:1},
      events:{
        onStateChange:onPlayerStateChange
      }
    });
  }
  setInterval(track,1000);
}

/* pause others when one plays */
function onPlayerStateChange(event){
  if(event.data===YT.PlayerState.PLAYING){
    for(let id in players){
      if(players[id]!==event.target){
        players[id].pauseVideo();
      }
    }
  }
}

/* restore when code entered */
document.getElementById("code").addEventListener("change",()=>{
  const code=document.getElementById("code").value.trim();
  if(!code) return;
  restoreState(code);
});

function track(){
  const code=document.getElementById("code").value.trim();
  if(!code) return;

  let completed=0;

  Object.keys(players).forEach((id,index)=>{
    const p=players[id];
    if(!p.getDuration) return;

    let d=p.getDuration();
    if(!d) return;

    let percent=(p.getCurrentTime()/d)*100;
    let saved=parseFloat(localStorage.getItem(code+"_"+id))||0;

    if(percent>saved+5){
      p.seekTo(saved/100*d,true);
    } else {
      localStorage.setItem(code+"_"+id,percent);
    }

    if(percent>5){
      localStorage.setItem(code+"_lastVideo",id);
    }

    if(percent>90){
      document.getElementById("c"+(index+1)).style.display="inline";
      completed++;
      if(id==="player1") unlockVideo2();
    }
  });

  let progress=(completed/2)*100;
  document.getElementById("bar1").style.width=progress+"%";
  document.getElementById("p1").innerText=Math.round(progress)+"% complete";

  if(progress===100){
    unlockModule2();
  }
}

/* restore state */
function restoreState(code){

  const last = localStorage.getItem(code+"_lastVideo");

  if(localStorage.getItem(code+"_player1")>90){
    document.getElementById("c1").style.display="inline";
    unlockVideo2();
  }

  if(localStorage.getItem(code+"_player2")>90){
    document.getElementById("c2").style.display="inline";
  }

  if(last){
    document.getElementById("continue"+last.slice(-1)).style.display="inline";

    setTimeout(()=>{
      document.getElementById("block"+last.slice(-1)).scrollIntoView({
        behavior:"smooth",
        block:"center"
      });
    },800);
  }

  resumeLastVideo(code,last);

  if(localStorage.getItem(code+"_player2")>90){
    unlockModule2();
  }
}

/* resume ONLY last video */
function resumeLastVideo(code,last){
  if(!last) return;

  const p=players[last];
  if(p && p.getDuration){
    let saved=localStorage.getItem(code+"_"+last);
    if(saved){
      let d=p.getDuration();
      p.seekTo(d*(saved/100),false);
      p.pauseVideo();
    }
  }
}

function unlockVideo2(){
  document.getElementById("block2").classList.remove("locked-video");
}

function unlockModule2(){
  document.getElementById("module2").classList.remove("locked");
}
</script>

</body>
</html>
