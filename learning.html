<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>KCMH DBT Research</title>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#eef7f3;
  color:#2f4f4f;
}

header{
  text-align:center;
  padding:25px;
  background:#dff3ea;
}

.container{
  max-width:900px;
  margin:auto;
  padding:30px;
}

.module{
  padding:25px;
  border-radius:16px;
  margin-bottom:25px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
}

.mindfulness{ background:#e8f4ef; }
.emotion{ background:#e6f3f3; }
.distress{ background:#f3efe6; }
.interpersonal{ background:#efe9f4; }

.locked{
  opacity:.5;
  pointer-events:none;
}

.video-block{
  margin-top:15px;
}

.badge{
  background:#7ec8a9;
  color:white;
  padding:3px 10px;
  border-radius:12px;
  font-size:12px;
}

.continue{
  font-size:12px;
  color:#2f4f4f;
  margin-left:8px;
}

.progress-bar{
  height:10px;
  background:#e0f2ea;
  border-radius:10px;
  margin-top:15px;
  overflow:hidden;
}

.progress-fill{
  height:100%;
  width:0%;
  background:#7ec8a9;
}

.percent{ margin-top:6px; }
</style>
</head>
<body>

<header>
  <h2>KCMH DBT Research</h2>
  <div id="participant"></div>
</header>

<div class="container">

<!-- MINDFULNESS -->
<div class="module mindfulness">
<h3>üßò Mindfulness</h3>

<div class="video-block">
<strong>Video 1: Intro to What Skills</strong>
<span id="c1" class="badge" style="display:none;">‚úì</span>
<span id="continue1" class="continue" style="display:none;">Continue watching</span>
<div id="player1"></div>
</div>

<div class="video-block" id="video2block" style="opacity:.4; pointer-events:none;">
<strong>Video 2: What Skill: Observe</strong>
<span id="c2" class="badge" style="display:none;">‚úì</span>
<span id="continue2" class="continue" style="display:none;">Continue watching</span>
<div id="player2"></div>
</div>

<div class="progress-bar"><div id="bar1" class="progress-fill"></div></div>
<div id="percent1" class="percent">0%</div>
</div>

<!-- OTHER MODULES -->
<div class="module emotion locked" id="module2">
<h3>üåø Emotion Regulation</h3>
<p>Unlocks after Mindfulness completion</p>
</div>

<div class="module distress locked">
<h3>ü™® Distress Tolerance</h3>
<p>Locked</p>
</div>

<div class="module interpersonal locked">
<h3>ü§ù Interpersonal Effectiveness</h3>
<p>Locked</p>
</div>

</div>

<script>
const code = sessionStorage.getItem("participant_code");
if(!code) window.location.href="index.html";

document.getElementById("participant").innerText="Participant: "+code;

const videos={
  player1:"gfvzWq8eW6s",
  player2:"PZBlkmMbzwI"
};

let players={};
let readyCount=0;

/* LOAD PLAYERS */
function onYouTubeIframeAPIReady(){
  Object.keys(videos).forEach(id=>{
    players[id]=new YT.Player(id,{
      height:"360",
      width:"100%",
      videoId:videos[id],
      events:{
        onReady:onReady,
        onStateChange:e=>handlePlay(e,id)
      }
    });
  });
}

function onReady(){
  readyCount++;
  if(readyCount===Object.keys(players).length){
    restoreProgress();
  }
}

/* allow only one video playing */
function handlePlay(e,current){
  if(e.data===YT.PlayerState.PLAYING){
    Object.keys(players).forEach(id=>{
      if(id!==current) players[id].pauseVideo();
    });
  }
}

/* TRACK PROGRESS */
setInterval(()=>{
  Object.keys(players).forEach((id,i)=>{
    const p=players[id];
    if(!p.getDuration) return;

    const time=p.getCurrentTime();
    const duration=p.getDuration();

    if(time>1){
      localStorage.setItem(code+"_lastVideo",id);
      localStorage.setItem(code+"_"+id+"_time",time);
    }

    const percent=(time/duration)*100;

    if(percent>90){
      document.getElementById("c"+(i+1)).style.display="inline";
      if(id==="player1"){
        document.getElementById("video2block").style.opacity="1";
        document.getElementById("video2block").style.pointerEvents="auto";
      }
    }
  });

  updateModuleProgress();
},1000);

/* UPDATE PROGRESS BAR */
function updateModuleProgress(){
  let completed=0;
  if(localStorage.getItem(code+"_player1_time") &&
     players.player1.getCurrentTime()/players.player1.getDuration()>0.9)
     completed++;
  if(localStorage.getItem(code+"_player2_time") &&
     players.player2.getCurrentTime()/players.player2.getDuration()>0.9)
     completed++;

  const progress=(completed/2)*100;
  document.getElementById("bar1").style.width=progress+"%";
  document.getElementById("percent1").innerText=Math.round(progress)+"% complete";

  if(progress===100){
    document.getElementById("module2").classList.remove("locked");
  }
}

/* RESTORE PROGRESS */
function restoreProgress(){
  const last=localStorage.getItem(code+"_lastVideo");

  Object.keys(players).forEach((id,i)=>{
    const saved=localStorage.getItem(code+"_"+id+"_time");
    if(saved){
      players[id].seekTo(parseFloat(saved),false);
      players[id].pauseVideo();
      document.getElementById("continue"+(i+1)).style.display="inline";
    }
  });

  if(last){
    setTimeout(()=>{
      document.getElementById(last).scrollIntoView({
        behavior:"smooth",
        block:"center"
      });
    },500);
  }

  updateModuleProgress();
}
</script>

</body>
</html>
